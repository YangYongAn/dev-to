name: Deploy Website to Vercel

on:
  push:
    branches:
      - main
    paths:
      - 'packages/website/**'
      - '.github/workflows/deploy-website.yml'

  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        id: vercel-deploy
        run: |
          set +e
          DEPLOYMENT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          EXIT_CODE=$?
          echo "$DEPLOYMENT"
          if [ $EXIT_CODE -eq 0 ]; then
            PREVIEW_URL=$(echo "$DEPLOYMENT" | tail -1)
            echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
            echo "âœ“ Deployed to: $PREVIEW_URL"
          else
            echo "âœ— Deployment failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Get Git Info
        id: git-info
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%ai)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Update Preview PR with Deployment Info
        env:
          PREVIEW_URL: ${{ steps.vercel-deploy.outputs.preview-url }}
          COMMIT_SHA: ${{ steps.git-info.outputs.sha }}
          COMMIT_AUTHOR: ${{ steps.git-info.outputs.author }}
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = process.env.PREVIEW_URL;
            const commitSha = process.env.COMMIT_SHA;
            const commitAuthor = process.env.COMMIT_AUTHOR;
            const prTitle = 'ðŸ” Preview: Website Preview Deployment';
            const prBranch = 'preview/website-staging';

            // æŸ¥æ‰¾çŽ°æœ‰ Preview PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${prBranch}`
            });

            const body = `## ðŸš€ Website Preview Deployment\n\n**Preview URL**: ${previewUrl}\n**Commit**: ${commitSha}\n**Author**: ${commitAuthor}\n\n### æ£€æŸ¥æ¸…å•\n- [ ] é¢„è§ˆæ•ˆæžœéªŒè¯é€šè¿‡\n- [ ] æ²¡æœ‰æž„å»ºé”™è¯¯\n- [ ] å“åº”å¼è®¾è®¡æ­£å¸¸\n\næ›´æ–°æ—¶é—´: ${new Date().toISOString()}`;

            if (prs.data.length > 0) {
              console.log(`âœ“ æ›´æ–° Preview PR #${prs.data[0].number}`);
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prs.data[0].number,
                body: body
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: `ðŸ”„ æ›´æ–° - ${commitSha}`
              });
            } else {
              console.log(`âœ“ åˆ›å»ºæ–° Preview PR`);
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/heads/${prBranch}`,
                  sha: context.sha
                });
              } catch (e) {}
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                body: body,
                head: prBranch,
                base: 'main'
              });
              console.log(`âœ“ Created PR #${pr.data.number}`);
            }
