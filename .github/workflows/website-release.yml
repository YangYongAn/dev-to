name: Website Release

on:
  workflow_dispatch:
    inputs:
      version-type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: website-release
  cancel-in-progress: false

jobs:
  create-release-pr:
    name: Create Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git Config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Read Current Version
        id: version
        run: |
          CURRENT_VERSION=$(cat packages/website/package.json | jq -r '.version')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Calculate next version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          if [ "${{ github.event.inputs.version-type }}" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "${{ github.event.inputs.version-type }}" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "next=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Version
        run: |
          pnpm pkg set version="${{ steps.version.outputs.next }}"
        working-directory: packages/website

      - name: Create Changeset
        run: |
          mkdir -p .changeset
          cat > .changeset/release-${{ github.run_id }}.md << 'EOF'
          ---
          "@dev-to/website": ${{ github.event.inputs.version-type }}
          ---

          Release website version ${{ steps.version.outputs.next }}
          EOF

      - name: Generate Changelog
        id: changelog
        run: |
          # Get git log since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~1")
          CHANGELOG=$(git log $LAST_TAG..HEAD --oneline --grep="^feat\|^fix\|^perf" -- packages/website/ 2>/dev/null || echo "No changes found")

          # Format for output
          CHANGELOG=$(echo "$CHANGELOG" | sed 's/^/- /')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release Branch
        run: |
          git checkout -b release/website-v${{ steps.version.outputs.next }}
          git add packages/website/package.json .changeset/
          git commit -m "chore(website): release v${{ steps.version.outputs.next }}"
          git push origin release/website-v${{ steps.version.outputs.next }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const head = `release/website-v${{ steps.version.outputs.next }}`;
            const title = `üöÄ Release website v${{ steps.version.outputs.next }}`;
            const body = `
            ## Release Information

            **Current Version**: ${{ steps.version.outputs.current }}
            **New Version**: ${{ steps.version.outputs.next }}
            **Type**: ${{ github.event.inputs.version-type }}

            ## Changes
            \`\`\`
            ${{ steps.changelog.outputs.content }}
            \`\`\`

            ## Checklist
            - [ ] Changes look good
            - [ ] Version number is correct
            - [ ] Changelog is accurate

            ## Next Steps
            After approving this PR:
            1. Website will be deployed to production
            2. GitHub Release will be created
            3. You can see the live site at https://www.dev-to.host
            `;

            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${head}`,
              state: 'open'
            });

            if (existingPRs.data.length > 0) {
              console.log('Release PR already exists');
              return;
            }

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: head,
              base: 'main'
            });

            console.log(`Created PR: ${pr.data.html_url}`);

      - name: Output Results
        run: |
          echo "‚úÖ Release PR created"
          echo "üìù Version: ${{ steps.version.outputs.current }} ‚Üí ${{ steps.version.outputs.next }}"
