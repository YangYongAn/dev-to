name: Deploy Website Production

on:
  push:
    branches:
      - main
    paths:
      - 'packages/website/package.json'
  workflow_dispatch:

concurrency:
  group: website-production-deploy
  cancel-in-progress: false

jobs:
  check-version-change:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.check.outputs.changed }}
      version: ${{ steps.check.outputs.version }}
      previous-version: ${{ steps.check.outputs.previous }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check Version Change
        id: check
        run: |
          CURRENT_VERSION=$(cat packages/website/package.json | jq -r '.version')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get previous version from git
          if git rev-parse HEAD~1 > /dev/null 2>&1; then
            PREVIOUS_VERSION=$(git show HEAD~1:packages/website/package.json | jq -r '.version' 2>/dev/null || echo "unknown")
            echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "previous=0.0.0" >> $GITHUB_OUTPUT
          fi

  deploy-production:
    name: Deploy to Production
    needs: check-version-change
    if: needs.check-version-change.outputs.version-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Vercel CLI
        run: pnpm add -g vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-version-change.outputs.version }}';
            const previousVersion = '${{ needs.check-version-change.outputs.previous-version }}';

            // Get changelog from git
            const { execSync } = require('child_process');
            let changelog = '';
            try {
              changelog = execSync(`git log --oneline --grep="^feat\\|^fix\\|^perf" v${previousVersion}..HEAD -- packages/website/ 2>/dev/null || echo "No detailed changes found"`, { encoding: 'utf-8' });
            } catch (e) {
              changelog = 'No detailed changes found';
            }

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `website-v${version}`,
              name: `Website v${version}`,
              body: `## Website Release v${version}

            ### Previous Version
            ${previousVersion}

            ### Changes
            \`\`\`
            ${changelog}
            \`\`\`

            ### Deployment
            ğŸŒ **Live at**: https://www.dev-to.host

            _Generated by GitHub Actions_
            `,
              draft: false,
              prerelease: false
            });

            console.log(`Created release: ${release.data.html_url}`);

      - name: Deploy Notification
        run: |
          echo "âœ… Production Deployment Complete"
          echo "ğŸ“¦ Version: ${{ needs.check-version-change.outputs.version }}"
          echo "ğŸŒ URL: https://www.dev-to.host"
