name: CI

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - closed
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_release_packages:
        description: Run package release job
        type: boolean
        default: true
      run_website_preview:
        description: Run website preview deploy
        type: boolean
        default: false
      run_website_release:
        description: Run website production deploy
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      website: ${{ steps.filter.outputs.website || steps.fallback.outputs.website }}
      changeset: ${{ steps.filter.outputs.changeset || steps.fallback.outputs.changeset }}
      publishable: ${{ steps.filter.outputs.publishable || steps.fallback.outputs.publishable }}
    steps:
      - name: Checkout
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect website changes
        if: github.event_name == 'push'
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            website:
              - 'packages/website/**'
            changeset:
              - '.changeset/**'
            publishable:
              - 'packages/react-shared/package.json'
              - 'packages/react-shared/CHANGELOG.md'
              - 'packages/react-plugin/package.json'
              - 'packages/react-plugin/CHANGELOG.md'
              - 'packages/react-loader/package.json'
              - 'packages/react-loader/CHANGELOG.md'
              - 'packages/create-dev-to/package.json'
              - 'packages/create-dev-to/CHANGELOG.md'

      - name: Default outputs
        if: github.event_name != 'push'
        id: fallback
        run: |
          echo "website=false" >> "$GITHUB_OUTPUT"
          echo "changeset=false" >> "$GITHUB_OUTPUT"
          echo "publishable=false" >> "$GITHUB_OUTPUT"

  release-packages:
    needs: changes
    if: (github.event_name == 'push' && (needs.changes.outputs.changeset == 'true' || needs.changes.outputs.publishable == 'true')) || (github.event_name == 'workflow_dispatch' && inputs.run_release_packages == 'true')
    uses: ./.github/workflows/release-packages.yml
    secrets: inherit

  website-preview:
    needs: changes
    if: (github.event_name == 'push' && needs.changes.outputs.website == 'true' && !contains(github.event.head_commit.message, 'release website')) || (github.event_name == 'workflow_dispatch' && inputs.run_website_preview == 'true')
    uses: ./.github/workflows/website-preview-deploy.yml
    secrets: inherit

  website-release:
    if: (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'website-release') || (github.event_name == 'workflow_dispatch' && inputs.run_website_release == 'true')
    uses: ./.github/workflows/website-release-deploy.yml
    secrets: inherit
