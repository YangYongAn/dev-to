name: Website Release Deploy

on:
  pull_request:
    types: [closed]
    branches:
      - main

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-production:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # ä»…å½“ PR è¢«åˆå¹¶ä¸”æ¥è‡ª website-release åˆ†æ”¯æ—¶è§¦å‘
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       github.event.pull_request.head.ref == 'website-release' &&
       github.event.pull_request.base.ref == 'main')
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Website
        run: pnpm build
        working-directory: packages/website

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Pull Vercel Project Info
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build with Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel Production
        id: vercel-deploy
        run: |
          DEPLOYMENT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          echo "Vercel Output:"
          echo "$DEPLOYMENT"

          PRODUCTION_URL=$(echo "$DEPLOYMENT" | grep -oP '(?<=https://)([^/]+)' | grep -v vercel.com | head -1 || echo "")

          if [ -z "$PRODUCTION_URL" ]; then
            # å°è¯•ä» vercel.com URL ä¸­æå–
            PRODUCTION_URL=$(echo "$DEPLOYMENT" | grep -oP 'https://[^\s]+' | head -1)
          fi

          if [ -z "$PRODUCTION_URL" ]; then
            echo "âŒ Failed to extract production URL"
            exit 1
          fi

          echo "production-url=$PRODUCTION_URL" >> $GITHUB_OUTPUT
          echo "âœ… Production deployed: $PRODUCTION_URL"
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Get Release Version
        id: release-info
        run: |
          VERSION=$(jq -r '.version' packages/website/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          COMMIT_MSG=$(git log -1 --format='%s')
          echo "commit-msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.release-info.outputs.version }}';
            const productionUrl = '${{ steps.vercel-deploy.outputs.production-url }}';
            const commitMsg = '${{ steps.release-info.outputs.commit-msg }}';

            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: \`website-v\${version}\`,
                name: \`Website v\${version}\`,
                body: \`## ğŸš€ Website Release v\${version}

### ğŸ“¦ éƒ¨ç½²ä¿¡æ¯
- **ç”Ÿäº§ç¯å¢ƒ URL**: [${productionUrl}](${productionUrl})
- **éƒ¨ç½²æ—¶é—´**: \${new Date().toISOString().split('T')[0]}
- **éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ

### ğŸ“ æäº¤ä¿¡æ¯
\`\${commitMsg}\`

---
_æ­¤ç‰ˆæœ¬å·²å‘å¸ƒåˆ° Vercel Production_
\`,
                draft: false,
                prerelease: false,
              });

              console.log(\`âœ… Release created: v\${version}\`);
            } catch (error) {
              console.log('âš ï¸  Release tag might already exist, skipping creation');
              console.log(error.message);
            }

      - name: Output Deployment Info
        run: |
          echo "ğŸ‰ Website Production Deployment Complete!"
          echo ""
          echo "ğŸ“Š Deployment Info:"
          echo "  Version: v${{ steps.release-info.outputs.version }}"
          echo "  Production URL: ${{ steps.vercel-deploy.outputs.production-url }}"
          echo "  Deployed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "âœ¨ Website is live!"
