name: CI Dispatcher

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    name: Detect Change Type
    runs-on: ubuntu-latest
    outputs:
      has-website-changes: ${{ steps.detect.outputs.has-website-changes }}
      has-public-package-changes: ${{ steps.detect.outputs.has-public-package-changes }}
      change-type: ${{ steps.detect.outputs.change-type }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          # è·å–æ”¹åŠ¨çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff HEAD~1..HEAD --name-only)
          echo "ğŸ“‹ Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # åˆå§‹åŒ–æ ‡å¿—
          HAS_WEBSITE=false
          HAS_PUBLIC_PKG=false

          # æ£€æŸ¥ website æ”¹åŠ¨
          if echo "$CHANGED_FILES" | grep -q "^packages/website/"; then
            HAS_WEBSITE=true
            echo "âœ… Website changes detected"
          fi

          # æ£€æŸ¥å…¬å¼€åŒ…æ”¹åŠ¨ï¼ˆæ’é™¤ websiteï¼‰
          if echo "$CHANGED_FILES" | grep -q "^packages/" && ! echo "$CHANGED_FILES" | grep -q "^packages/website/"; then
            HAS_PUBLIC_PKG=true
            echo "âœ… Public package changes detected"
          fi

          # æ£€æŸ¥ PR æ”¹åŠ¨ï¼ˆversion/changesetï¼‰
          HAS_RELEASE_PR=false
          if echo "$CHANGED_FILES" | grep -qE "(\.changeset|package\.json)"; then
            HAS_RELEASE_PR=true
            echo "âœ… Release-related changes detected"
          fi

          # åˆ¤æ–­å˜æ›´ç±»å‹
          if [ "$HAS_PUBLIC_PKG" = true ]; then
            CHANGE_TYPE="npm-package"
            echo "ğŸ“¦ Change type: NPM Package"
          elif [ "$HAS_WEBSITE" = true ]; then
            CHANGE_TYPE="website"
            echo "ğŸŒ Change type: Website"
          elif [ "$HAS_RELEASE_PR" = true ]; then
            CHANGE_TYPE="release-pr"
            echo "ğŸš€ Change type: Release PR"
          else
            CHANGE_TYPE="other"
            echo "ğŸ“„ Change type: Other (docs, chore, etc)"
          fi

          # è¾“å‡ºç»“æœ
          echo "has-website-changes=$HAS_WEBSITE" >> $GITHUB_OUTPUT
          echo "has-public-package-changes=$HAS_PUBLIC_PKG" >> $GITHUB_OUTPUT
          echo "change-type=$CHANGE_TYPE" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ¯ Summary:"
          echo "  Website changes: $HAS_WEBSITE"
          echo "  Public package changes: $HAS_PUBLIC_PKG"
          echo "  Change type: $CHANGE_TYPE"

  report-website-preview:
    name: Website Preview Deploy
    needs: detect-changes
    if: needs.detect-changes.outputs.has-website-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Website changes detected
        run: |
          echo "ğŸŒ Website Preview Deploy will be triggered"
          echo "   - Detected website changes in packages/website/"
          echo "   - Will deploy preview to Vercel"
          echo "   - Will create/update Release PR to website-release branch"

  report-npm-release:
    name: NPM Release
    needs: detect-changes
    if: needs.detect-changes.outputs.has-public-package-changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Public package changes detected
        run: |
          echo "ğŸ“¦ NPM Release will be triggered"
          echo "   - Detected public package changes"
          echo "   - Will check changeset and publish to NPM"

  report-skip:
    name: CI Summary
    needs: detect-changes
    if: needs.detect-changes.outputs.change-type == 'other' || needs.detect-changes.outputs.change-type == 'release-pr'
    runs-on: ubuntu-latest
    steps:
      - name: â­ï¸ No CI workflows triggered
        run: |
          echo "Change type: ${{ needs.detect-changes.outputs.change-type }}"
          echo ""
          echo "This is OK for:"
          echo "  âœ“ Documentation only changes"
          echo "  âœ“ Chore updates"
          echo "  âœ“ Release PR updates"
          echo "  âœ“ CI config updates"

  final-summary:
    name: CI Dispatch Summary
    needs: detect-changes
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Print Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š CI Dispatcher Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Detected Changes:"
          echo "  â€¢ Website changes: ${{ needs.detect-changes.outputs.has-website-changes }}"
          echo "  â€¢ Public package changes: ${{ needs.detect-changes.outputs.has-public-package-changes }}"
          echo "  â€¢ Change type: ${{ needs.detect-changes.outputs.change-type }}"
          echo ""
          echo "CI Decisions:"
          if [ "${{ needs.detect-changes.outputs.has-website-changes }}" = "true" ]; then
            echo "  âœ… Website Preview Deploy WILL run"
          else
            echo "  âŒ Website Preview Deploy SKIPPED"
          fi
          if [ "${{ needs.detect-changes.outputs.has-public-package-changes }}" = "true" ]; then
            echo "  âœ… NPM Release WILL run"
          else
            echo "  âŒ NPM Release SKIPPED"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
