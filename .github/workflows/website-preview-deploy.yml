name: Website Preview Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'packages/website/**'
      - '.github/workflows/website-preview-deploy.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    name: Deploy to Vercel Preview
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      preview-url: ${{ steps.vercel-deploy.outputs.preview-url }}
      current-version: ${{ steps.version-info.outputs.current }}
      new-version: ${{ steps.version-info.outputs.next }}
      version-type: ${{ steps.version-info.outputs.type }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Website
        run: pnpm build
        working-directory: packages/website

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Pull Vercel Project Info
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build with Vercel
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel Preview
        id: vercel-deploy
        run: |
          DEPLOYMENT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          echo "Vercel Output:"
          echo "$DEPLOYMENT"

          PREVIEW_URL=$(echo "$DEPLOYMENT" | grep -oP 'https://[^\s]+' | head -1)
          if [ -z "$PREVIEW_URL" ]; then
            echo "âŒ Failed to extract preview URL"
            exit 1
          fi

          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… Preview deployed: $PREVIEW_URL"
        working-directory: packages/website
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Get Current Version
        id: version-info
        run: |
          CURRENT_VERSION=$(jq -r '.version' packages/website/package.json)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # èŽ·å–ä¸Šä¸€ä¸ª release commit
          LAST_RELEASE_COMMIT=$(git log --all --grep="chore(website): release" -1 --format="%H" 2>/dev/null || echo "HEAD")

          # ç»Ÿè®¡ feat å’Œ fix æäº¤
          FEAT_COUNT=$(git log $LAST_RELEASE_COMMIT..HEAD -- packages/website/ 2>/dev/null | grep -c "^    feat\|^    Feat" || echo 0)
          FIX_COUNT=$(git log $LAST_RELEASE_COMMIT..HEAD -- packages/website/ 2>/dev/null | grep -c "^    fix\|^    Fix" || echo 0)

          # æ™ºèƒ½è®¡ç®—æ–°ç‰ˆæœ¬
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          if [ $FEAT_COUNT -gt 0 ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            VERSION_TYPE="minor"
          elif [ $FIX_COUNT -gt 0 ]; then
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            VERSION_TYPE="patch"
          else
            NEW_VERSION=$CURRENT_VERSION
            VERSION_TYPE="none"
          fi

          echo "next=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "type=$VERSION_TYPE" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Version Info:"
          echo "  Current: $CURRENT_VERSION"
          echo "  Next: $NEW_VERSION"
          echo "  Type: $VERSION_TYPE"
          echo "  Feat commits: $FEAT_COUNT"
          echo "  Fix commits: $FIX_COUNT"

      - name: Get Changelog
        id: changelog
        run: |
          LAST_RELEASE_COMMIT=$(git log --all --grep="chore(website): release" -1 --format="%H" 2>/dev/null || echo "HEAD~10")

          CHANGELOG=$(git log $LAST_RELEASE_COMMIT..HEAD -- packages/website/ \
            --pretty=format:"- %s" \
            | grep -E "^- (feat|fix)" || echo "No conventional commits found")

          # å¤„ç†å¤šè¡Œè¾“å‡º
          CHANGELOG=$(echo "$CHANGELOG" | head -20)
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"

          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

  create-release-pr:
    name: Create/Update Release PR
    needs: deploy-preview
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: needs.deploy-preview.outputs.version-type != 'none'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Create/Update Release Branch
        run: |
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git rev-parse --verify website-release 2>/dev/null; then
            echo "âœ… Checking out existing website-release branch"
            git checkout website-release
            git pull origin main --rebase || true
          else
            echo "âœ… Creating new website-release branch"
            git checkout -b website-release
          fi

      - name: Update Version in package.json
        run: |
          pnpm pkg set version="${{ needs.deploy-preview.outputs.new-version }}" --prefix packages/website

      - name: Create Changeset File
        run: |
          CHANGESET_FILE=".changeset/website-release-$(date +%s).md"
          mkdir -p .changeset

          cat > "$CHANGESET_FILE" << 'EOF'
          ---
          "@dev-to/website": ${{ needs.deploy-preview.outputs.version-type }}
          ---

          Release website version ${{ needs.deploy-preview.outputs.new-version }}
          EOF

      - name: Commit Changes
        run: |
          git add packages/website/package.json .changeset/

          COMMIT_MSG="chore(website): release v${{ needs.deploy-preview.outputs.new-version }}"

          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if ! git diff --cached --quiet; then
            git commit -m "$COMMIT_MSG"
            echo "âœ… Changes committed"
          else
            echo "âš ï¸  No changes to commit"
          fi

      - name: Push Release Branch
        run: |
          git push -u origin website-release || git push origin website-release -f

      - name: Create/Update Release PR
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = 'ðŸš€ Website Release: v${{ needs.deploy-preview.outputs.new-version }}';
            const prHead = 'website-release';
            const prBase = 'main';

            // èŽ·å–å½“å‰æäº¤ä¿¡æ¯
            const currentVersion = '${{ needs.deploy-preview.outputs.current-version }}';
            const newVersion = '${{ needs.deploy-preview.outputs.new-version }}';
            const versionType = '${{ needs.deploy-preview.outputs.version-type }}';
            const previewUrl = '${{ needs.deploy-preview.outputs.preview-url }}';

            // æž„å»º PR å†…å®¹
            const prBody = `## ðŸš€ Website Release

### ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯
- **å½“å‰ç‰ˆæœ¬**: \`${currentVersion}\`
- **æ–°ç‰ˆæœ¬**: \`${newVersion}\`
- **ç‰ˆæœ¬ç±»åž‹**: \`${versionType}\`

### ðŸ”— é¢„è§ˆé“¾æŽ¥
- **Preview URL**: [${previewUrl}](${previewUrl})
- **éƒ¨ç½²æ—¶é—´**: ${new Date().toISOString().split('T')[0]}
- **éƒ¨ç½²çŠ¶æ€**: âœ… æˆåŠŸ

### ðŸ“ å˜æ›´æ‘˜è¦
\`\`\`
${{ needs.deploy-preview.outputs.version-type != 'none' && 'Website updates' || 'No changes' }}
\`\`\`

### âœ¨ å¦‚ä½•å‘å¸ƒï¼Ÿ
1. æ£€æŸ¥é¢„è§ˆé“¾æŽ¥ä¸­çš„æ›´æ”¹
2. å¦‚æžœæ»¡æ„ï¼Œåˆå¹¶æ­¤ PR åˆ° \`main\`
3. è‡ªåŠ¨éƒ¨ç½²åˆ° Vercel Production

---
_æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œä¼šåœ¨æœ‰æ–°çš„ website æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°ã€‚_
`;

            // æŸ¥æ‰¾çŽ°æœ‰ PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: \`\${context.repo.owner}:\${prHead}\`,
              base: prBase,
            });

            if (prs.data.length > 0) {
              // æ›´æ–°çŽ°æœ‰ PR
              const pr = prs.data[0];
              console.log(\`âœ… Updating existing PR #\${pr.number}\`);

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: prTitle,
                body: prBody,
              });

              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: \`ðŸ”„ **Preview Updated**

Preview URL: [\${previewUrl}](${previewUrl})

Deployed at: \${new Date().toLocaleString()}

âœ¨ Ready for review and merge to production!\`,
              });
            } else {
              // åˆ›å»ºæ–° PR
              console.log('âœ… Creating new PR');

              const newPr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: prHead,
                base: prBase,
                body: prBody,
              });

              console.log(\`âœ… PR created: #\${newPr.data.number}\`);
            }
