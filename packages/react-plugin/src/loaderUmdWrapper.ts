import { PLUGIN_LOG_PREFIX, STABLE_CONTRACT_PATH } from './constants.js'
import { toSafeUmdName } from './libBuildUtils.js'

interface CreateLoaderUmdWrapperOptions {
  componentName: string
  origin: string
  contractEndpoint?: string
}

/**
 * Generate a lightweight UMD wrapper that uses @dev-to/react-loader to load the component.
 * This wrapper depends on react-loader UMD build being available.
 */
export function createLoaderUmdWrapper(options: CreateLoaderUmdWrapperOptions): string {
  const { componentName, origin, contractEndpoint = STABLE_CONTRACT_PATH } = options
  const globalName = toSafeUmdName(componentName)

  // Generate UMD wrapper code
  const code = `/**
 * UMD Loader Wrapper for component: ${componentName}
 * Global name: ${globalName}
 * Generated by ${PLUGIN_LOG_PREFIX}
 *
 * This wrapper uses @dev-to/react-loader to dynamically load and render the component.
 *
 * Usage:
 * 1. Load React and ReactDOM:
 *    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
 *    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
 *
 * 2. Load ReactLoader:
 *    <script src="https://cdn.jsdelivr.net/npm/@dev-to/react-loader@latest/dist/index.umd.js"></script>
 *
 * 3. Load this wrapper:
 *    <script src="${origin}/__dev_to_react__/loader/${componentName}.js"></script>
 *
 * 4. Render the component:
 *    <div id="app"></div>
 *    <script>
 *      window.${globalName}.render(
 *        document.getElementById('app'),
 *        { /* your props */ }
 *      );
 *    </script>
 */
(function (root, factory) {
  if (typeof exports === 'object' && typeof module !== 'undefined') {
    // CommonJS
    factory(exports, require('react'), require('react-dom'), require('@dev-to/react-loader'));
  } else if (typeof define === 'function' && define.amd) {
    // AMD
    define(['exports', 'react', 'react-dom', '@dev-to/react-loader'], factory);
  } else {
    // Browser globals
    var globalObj = typeof globalThis !== 'undefined' ? globalThis : (typeof self !== 'undefined' ? self : root);
    factory((globalObj.${globalName} = {}), globalObj.React, globalObj.ReactDOM, globalObj.DevToReactLoader);
  }
})(this, function (exports, React, ReactDOM, ReactLoaderModule) {
  'use strict';

  // Get ReactLoader component from the module
  var ReactLoader = ReactLoaderModule && ReactLoaderModule.ReactLoader;

  if (!ReactLoader) {
    throw new Error(
      '${PLUGIN_LOG_PREFIX} ReactLoader not found. ' +
      'Please load @dev-to/react-loader before this script: ' +
      '<script src="https://cdn.jsdelivr.net/npm/@dev-to/react-loader@latest/dist/index.umd.js"></script>'
    );
  }

  // Component configuration
  var config = {
    origin: ${JSON.stringify(origin)},
    name: ${JSON.stringify(componentName)},
    contractEndpoint: ${JSON.stringify(contractEndpoint)}
  };

  /**
   * Render the component using ReactLoader
   */
  function render(targetElement, componentProps) {
    if (!targetElement) {
      throw new Error('${PLUGIN_LOG_PREFIX} Target element is required');
    }

    if (!React || !React.createElement) {
      throw new Error('${PLUGIN_LOG_PREFIX} React is not loaded');
    }

    if (!ReactDOM || !ReactDOM.createRoot) {
      throw new Error('${PLUGIN_LOG_PREFIX} ReactDOM is not loaded');
    }

    // Create ReactLoader component props
    var loaderProps = {
      origin: config.origin,
      name: config.name,
      contractEndpoint: config.contractEndpoint,
      componentProps: componentProps || {}
    };

    // Render using ReactLoader
    var root = ReactDOM.createRoot(targetElement);
    root.render(React.createElement(ReactLoader, loaderProps));

    return root;
  }

  // Export the API
  exports.render = render;
  exports.config = config;
  exports.default = { render: render, config: config };

  // Mark as ES module
  Object.defineProperty(exports, '__esModule', { value: true });
});
`

  return code
}
