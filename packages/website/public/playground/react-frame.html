<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React Frame</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      overflow: auto;
    }

    #root {
      padding: 24px;
      min-height: 100vh;
    }

    .loading {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top-color: #3fb950;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      padding: 24px;
      background: #fee;
      border-left: 4px solid #c00;
      border-radius: 4px;
      color: #c00;
      margin: 24px;
    }

    .error h3 {
      margin-bottom: 8px;
    }

    .error pre {
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-word;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading React component...</p>
    </div>
  </div>

  <!-- Load React from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script type="module">
    // Get URL parameters
    const params = new URLSearchParams(window.location.search)
    const origin = params.get('origin') || 'http://localhost:5173'
    const componentName = params.get('name') || 'RemoteCard'

    console.log('[React Frame] Loading component:', { origin, componentName })

    // Props state
    let currentProps = { title: 'Hello from Playground' }

    // Listen for props updates from parent
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'dev-to:update-props') {
        console.log('[React Frame] Received props update:', e.data.props)
        currentProps = e.data.props
        // Re-render component with new props
        renderComponent()
      }
    })

    // Root container
    const container = document.getElementById('root')
    let reactRoot = null

    // Dynamic import helper
    const nativeImport = new Function('url', 'return import(url)')

    // Load and render component
    async function loadComponent() {
      try {
        // Try to load ReactLoader from the dev server
        const loaderModule = await nativeImport(`${origin}/@dev-to/react-loader`)
        const ReactLoader = loaderModule.ReactLoader || loaderModule.default

        if (!ReactLoader) {
          throw new Error('ReactLoader not found in module')
        }

        console.log('[React Frame] ReactLoader loaded successfully')

        // Create React element
        const element = React.createElement(ReactLoader, {
          origin: origin,
          name: componentName,
          componentProps: currentProps,
          loading: React.createElement('div', { className: 'loading' },
            React.createElement('div', { className: 'spinner' }),
            React.createElement('p', null, 'Loading component...')
          ),
          renderError: (error) => {
            return React.createElement('div', { className: 'error' },
              React.createElement('h3', null, 'Component Load Error'),
              React.createElement('pre', null, error.message || String(error))
            )
          }
        })

        // Create or update root
        if (!reactRoot) {
          reactRoot = ReactDOM.createRoot(container)
        }
        reactRoot.render(element)

        // Notify parent that component is ready
        window.parent.postMessage({
          type: 'dev-to:component-ready',
          componentName: componentName
        }, '*')
      }
      catch (error) {
        console.error('[React Frame] Failed to load component:', error)
        showError(error)

        // Notify parent of error
        window.parent.postMessage({
          type: 'dev-to:error',
          error: error.message || String(error)
        }, '*')
      }
    }

    function renderComponent() {
      if (reactRoot) {
        loadComponent()
      }
    }

    function showError(error) {
      container.innerHTML = `
        <div class="error">
          <h3>Failed to Load Component</h3>
          <p><strong>Origin:</strong> ${origin}</p>
          <p><strong>Component:</strong> ${componentName}</p>
          <pre>${error.message || String(error)}</pre>
          <p style="margin-top: 12px; color: #666;">
            Make sure the dev server is running at <code>${origin}</code>
            and the @dev-to/react-plugin is properly configured.
          </p>
        </div>
      `
    }

    // Forward HMR events to parent
    const HMR_EVENTS = ['dev_to:react:full-reload', 'dev_to:react:hmr-update']
    HMR_EVENTS.forEach(eventName => {
      window.addEventListener(eventName, (e) => {
        console.log('[React Frame] HMR event:', eventName, e.detail)
        window.parent.postMessage({
          type: 'dev-to:hmr-event',
          eventName: eventName,
          detail: e.detail
        }, '*')
      })
    })

    // Start loading
    loadComponent()
  </script>
</body>
</html>
